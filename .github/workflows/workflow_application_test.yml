name: Build and Deploy App (Test)

on:
  workflow_dispatch:
  push:
    branches:
      - "dev/**"
    paths:
      - "src/cicloso.tickets.api/**"
      - "src/cicloso.tickets.portal/**"
      - "src/cicloso.tickets.core/**"
      - "src/cicloso.tickets.entities/**"
      - "src/clicloso.tickets.database/**"

env:
  CONFIGURATION: Release
  WORKING_DIRECTORY: ./src
  API_PROJECT: cicloso.tickets.api
  PORTAL_PROJECT: cicloso.tickets.portal
  DATABASE_PROJECT: clicloso.tickets.database

permissions:
  id-token: write
  contents: read

jobs:
  # ========== BUILD JOBS ==========
  build-api:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3.1

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1.2.0

      - name: Restore NuGet packages
        run: nuget restore "${{ env.WORKING_DIRECTORY }}\cicloso.tickets.sln"

      - name: Build api
        run: msbuild "${{ env.WORKING_DIRECTORY }}\${{ env.API_PROJECT }}\${{ env.API_PROJECT }}.csproj" `
          /p:Configuration=Release ` 
          /p:DeployOnBuild=true `
          /p:DeployDefaultTarget=WebPublish `
          /p:WebPublishMethod=FileSystem `
          /p:publishUrl=${{ github.workspace }}\publish `
          /p:PrecompileBeforePublish=true `
          /p:EnableUpdateable=false

      - name: Compress artifact api
        run: compress-archive ${{ github.workspace }}\publish\* ${{ github.workspace }}\api.zip


      - name: Upload artifact api
        uses: actions/upload-artifact@v4
        with:
          name: api-artifact
          path: ${{ github.workspace }}/api.zip
          retention-days: 1

  build-portal:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3.1

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1.2.0

      - name: Restore NuGet packages
        run: nuget restore "${{ env.WORKING_DIRECTORY }}\cicloso.tickets.sln"

      - name: Build portal
        run: msbuild "${{ env.WORKING_DIRECTORY }}\${{ env.PORTAL_PROJECT }}\${{ env.PORTAL_PROJECT }}.csproj" `
          /p:Configuration=Release ` 
          /p:DeployOnBuild=true `
          /p:DeployDefaultTarget=WebPublish `
          /p:WebPublishMethod=FileSystem `
          /p:publishUrl=${{ github.workspace }}\publish `
          /p:PrecompileBeforePublish=true `
          /p:EnableUpdateable=false

      - name: Compress artifact portal
        run: compress-archive ${{ github.workspace }}\publish\* ${{ github.workspace }}\portal.zip
      
      - name: Upload artifact portal
        uses: actions/upload-artifact@v4
        with:
          name: portal-artifact
          path: ${{ github.workspace }}/portal.zip
          retention-days: 1

  build-database:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3.1

      - name: Build database
        run: msbuild "${{ env.WORKING_DIRECTORY }}\${{ env.DATABASE_PROJECT }}\${{ env.DATABASE_PROJECT }}.sqlproj" /p:Configuration=${{ env.CONFIGURATION }}

      - name: Upload artifact database
        uses: actions/upload-artifact@v4
        with:
          name: database-artifact
          path: ${{ env.WORKING_DIRECTORY }}/${{ env.DATABASE_PROJECT }}/bin/Output/*.dacpac
          retention-days: 1

  scan-code:
      runs-on: ubuntu-latest
      needs: [build-api, build-portal, build-database]
      steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Disabling shallow clones is recommended for improving the relevancy of reporting
          fetch-depth: 0

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v7.0.0 # Ex: v4.1.0 or sha1, See the latest version at https://github.com/marketplace/actions/official-sonarqube-scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: ${{ env.WORKING_DIRECTORY }}
          args: >
            -Dsonar.organization=daleospina
            -Dsonar.projectName=cicloso-tickets
            -Dsonar.projectKey=cicloso-tickets
            -Dsonar.sources=.
            -Dsonar.verbose=true

  # ========== TEST ENVIRONMENT DEPLOYMENT ==========
  deploy-api-test:
    runs-on: windows-latest
    timeout-minutes: 30
    needs: scan-code
    environment: test
    if: contains(github.ref, 'dev/')

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: api-artifact
          path: api-artifact

      - name: List API files
        run: dir api-artifact

      - name: Log in with Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          
      - name: Deploy to App Service
        uses: azure/webapps-deploy@v2
        with:
          resource-group-name: ${{ vars.AZURE_RESOURCEGROUP_NAME }}
          app-name: ${{ vars.AZURE_API_APPSERVICE_NAME }}
          package: api-artifact/api.zip

      - name: Verify API deployment
        run: |
          az webapp show `
            --resource-group ${{ vars.AZURE_RESOURCEGROUP_NAME }} `
            --name ${{ vars.AZURE_API_APPSERVICE_NAME }} `
            --query state

  deploy-portal-test:
    runs-on: windows-latest
    timeout-minutes: 30
    needs: scan-code
    environment: test
    if: contains(github.ref, 'dev/')

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: portal-artifact
          path: portal-artifact

      - name: List PORTAL files
        run: dir portal-artifact

      - name: Log in with Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to App Service
        uses: azure/webapps-deploy@v2
        with:
          resource-group-name: ${{ vars.AZURE_RESOURCEGROUP_NAME }}
          app-name: ${{ vars.AZURE_PORTAL_APPSERVICE_NAME }}
          package: portal-artifact/portal.zip

      - name: Verify Portal deployment
        run: |
          az webapp show `
            --resource-group ${{ vars.AZURE_RESOURCEGROUP_NAME }} `
            --name ${{ vars.AZURE_PORTAL_APPSERVICE_NAME }} `
            --query state

  deploy-database-test:
    runs-on: windows-latest
    timeout-minutes: 30
    needs: scan-code
    environment: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: database-artifact
          path: ${{ env.WORKING_DIRECTORY }}/artifact

      - name: Log in with Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: List downloaded Database artifact files
        run: dir ${{ env.WORKING_DIRECTORY }}\artifact

      - name: Azure SQL Deploy
        uses: Azure/sql-action@v2.3
        with:
          connection-string: '${{ vars.AZURE_SQL_CONNECTION_STRING }}'
          path: ${{ env.WORKING_DIRECTORY }}\artifact\${{ env.DATABASE_PROJECT }}.dacpac
          action: publish
          arguments: >
            /p:DropObjectsNotInSource=true
            /p:ExcludeObjectTypes=Users;Logins;RoleMembership

      - name: Verify database deployment
        run: |
          az sql db show `
            --resource-group ${{ vars.AZURE_RESOURCEGROUP_NAME }} `
            --server ${{ vars.AZURE_SQL_SERVER_NAME }} `
            --name ${{ vars.AZURE_SQL_DATABASE_NAME }} `
            --query status

  validate-perfomance-test:
    runs-on: ubuntu-latest
    needs: [deploy-api-test, deploy-portal-test, deploy-database-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Audit URLs
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            https://app-tickets-app-test-gwjeyl.azurewebsites.net/
            https://app-tickets-app-test-gwjeyl.azurewebsites.net/Customer
            https://app-tickets-app-test-gwjeyl.azurewebsites.net/City
            https://app-tickets-app-test-gwjeyl.azurewebsites.net/Theater
          uploadArtifacts: true # save results as an action artifacts
          temporaryPublicStorage: true # upload lighthouse report to the temporary storage
